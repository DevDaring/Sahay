{% extends 'base.html' %}

{% block title %}Chat with Sahay - Wellness{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 200px);
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .chat-header {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 1rem 2rem;
        border-radius: 10px 10px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        background: var(--background);
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .message {
        max-width: 80%;
        padding: 1rem;
        border-radius: 18px;
        position: relative;
        animation: fadeInUp 0.3s ease;
    }
    
    .message.user {
        align-self: flex-end;
        background: var(--primary);
        color: white;
        border-bottom-right-radius: 6px;
    }
    
    .message.ai {
        align-self: flex-start;
        background: white;
        border: 1px solid var(--gray-light);
        border-bottom-left-radius: 6px;
    }
    
    .message-time {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.5rem;
    }
    
    .typing-indicator {
        display: none;
        align-self: flex-start;
        background: white;
        border: 1px solid var(--gray-light);
        padding: 1rem;
        border-radius: 18px;
        border-bottom-left-radius: 6px;
    }
    
    .typing-dots {
        display: flex;
        gap: 0.3rem;
    }
    
    .typing-dots span {
        width: 8px;
        height: 8px;
        background: var(--gray);
        border-radius: 50%;
        animation: typingBounce 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    .chat-input-container {
        padding: 1rem;
        background: white;
        border-radius: 0 0 10px 10px;
        border-top: 1px solid var(--gray-light);
    }
    
    .chat-input-form {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
    }
    
    .chat-input {
        flex: 1;
        padding: 1rem;
        border: 2px solid var(--gray-light);
        border-radius: 25px;
        resize: none;
        font-family: inherit;
        font-size: 1rem;
        max-height: 100px;
        transition: border-color 0.3s;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .send-button {
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.1s;
    }
    
    .send-button:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
    }
    
    .send-button:disabled {
        background: var(--gray);
        cursor: not-allowed;
        transform: scale(1);
    }
    
    .language-selector {
        background: rgba(255,255,255,0.2);
        border: 1px solid rgba(255,255,255,0.3);
        color: white;
        border-radius: 20px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
    }
    
    .language-selector option {
        color: var(--text);
        background: white;
    }
    
    .quick-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }
    
    .quick-action {
        background: var(--gray-light);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        color: var(--text);
    }
    
    .quick-action:hover {
        background: var(--primary);
        color: white;
        transform: translateY(-2px);
    }
    
    .privacy-notice {
        background: var(--success-light);
        border: 1px solid var(--success);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-size: 0.9rem;
        color: var(--success-dark);
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes typingBounce {
        0%, 80%, 100% { 
            transform: scale(0);
        } 40% { 
            transform: scale(1);
        }
    }
    
    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 160px);
            margin: 1rem;
            border-radius: 0;
        }
        
        .message {
            max-width: 90%;
        }
        
        .chat-header {
            border-radius: 0;
        }
        
        .chat-input-container {
            border-radius: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 1rem;">
    <div class="chat-container">
        <div class="chat-header">
            <div>
                <h3 style="margin: 0;">ü§ñ Sahay AI Assistant</h3>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                    Your multilingual mental health companion
                </p>
            </div>
            <div>
                <select class="language-selector" id="languageSelect" onchange="changeLanguage()">
                    <option value="auto">üåê Auto-detect</option>
                    <option value="en">üá¨üáß English</option>
                    <option value="hi">üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                    <option value="bn">üáßüá© ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</option>
                </select>
            </div>
        </div>
        
        <div class="privacy-notice">
            üîí <strong>Your privacy is protected:</strong> All conversations are anonymized and encrypted. 
            No personal information is stored or shared.
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <p>Hello! I'm Sahay, your AI wellness companion. I'm here to support you with:</p>
                <ul style="margin: 0.5rem 0 0 1rem;">
                    <li>Mental health and emotional support</li>
                    <li>Study stress and academic pressure</li>
                    <li>Career guidance and planning</li>
                    <li>Mindfulness and relaxation techniques</li>
                </ul>
                <p>How can I help you today? You can speak to me in English, Hindi, or Bengali.</p>
                <div class="message-time">Just now</div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <span style="margin-left: 0.5rem; color: var(--gray);">Sahay is typing...</span>
        </div>
        
        <div class="chat-input-container">
            <div class="quick-actions">
                <button class="quick-action" onclick="sendQuickMessage('I am feeling stressed about my studies')">
                    üò∞ Study Stress
                </button>
                <button class="quick-action" onclick="sendQuickMessage('I need career guidance')">
                    üéØ Career Help
                </button>
                <button class="quick-action" onclick="sendQuickMessage('I am feeling anxious')">
                    üòü Feeling Anxious
                </button>
                <button class="quick-action" onclick="sendQuickMessage('Can you help me relax?')">
                    üßò‚Äç‚ôÄÔ∏è Relaxation
                </button>
                <button class="quick-action" onclick="sendQuickMessage('‡§Æ‡•Å‡§ù‡•á ‡§Æ‡§æ‡§®‡§∏‡§ø‡§ï ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ö‡§æ‡§π‡§ø‡§è')">
                    üáÆüá≥ Hindi Support
                </button>
            </div>
            
            <form class="chat-input-form" onsubmit="sendMessage(event)">
                <textarea 
                    id="messageInput" 
                    class="chat-input" 
                    placeholder="Type your message here... (Press Shift+Enter for new line)"
                    rows="1"
                    onkeydown="handleKeyDown(event)"
                    oninput="adjustTextareaHeight(this)"
                ></textarea>
                <button type="submit" class="send-button" id="sendButton">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentLanguage = 'auto';
    let isWaitingForResponse = false;
    
    function changeLanguage() {
        currentLanguage = document.getElementById('languageSelect').value;
        addMessage('system', `Language changed to: ${getLanguageName(currentLanguage)}`);
    }
    
    function getLanguageName(code) {
        const names = {
            'auto': 'Auto-detect',
            'en': 'English',
            'hi': '‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)',
            'bn': '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)'
        };
        return names[code] || code;
    }
    
    function sendQuickMessage(message) {
        document.getElementById('messageInput').value = message;
        sendMessage(new Event('submit'));
    }
    
    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage(event);
        }
    }
    
    function adjustTextareaHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }
    
    async function sendMessage(event) {
        event.preventDefault();
        
        if (isWaitingForResponse) return;
        
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Add user message
        addMessage('user', message);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Disable send button and show typing
        isWaitingForResponse = true;
        document.getElementById('sendButton').disabled = true;
        showTypingIndicator();
        
        try {
            // Send to API
            const response = await fetch('{% url "api:chat" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message: message,
                    language: currentLanguage,
                    session_id: getOrCreateSessionId()
                })
            });
            
            const data = await response.json();
            
            hideTypingIndicator();
            
            if (data.success) {
                addMessage('ai', data.response);
                
                // Update detected language if auto-detect
                if (data.detected_language && currentLanguage === 'auto') {
                    updateLanguageDetection(data.detected_language);
                }
            } else {
                addMessage('ai', 'Sorry, I encountered an error. Please try again.');
            }
        } catch (error) {
            console.error('Chat error:', error);
            hideTypingIndicator();
            addMessage('ai', 'Sorry, I had trouble connecting. Please check your internet connection and try again.');
        } finally {
            isWaitingForResponse = false;
            document.getElementById('sendButton').disabled = false;
            messageInput.focus();
        }
    }
    
    function addMessage(sender, content) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        if (sender === 'system') {
            messageDiv.style.alignSelf = 'center';
            messageDiv.style.background = 'var(--accent)';
            messageDiv.style.color = 'white';
            messageDiv.style.fontSize = '0.9rem';
            messageDiv.style.maxWidth = '60%';
        }
        
        const now = new Date();
        const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messageDiv.innerHTML = `
            <div>${formatMessage(content)}</div>
            <div class="message-time">${timeString}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function formatMessage(content) {
        // Convert URLs to links
        content = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
        
        // Convert newlines to <br>
        content = content.replace(/\n/g, '<br>');
        
        return content;
    }
    
    function showTypingIndicator() {
        document.getElementById('typingIndicator').style.display = 'flex';
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function hideTypingIndicator() {
        document.getElementById('typingIndicator').style.display = 'none';
    }
    
    function updateLanguageDetection(detectedLang) {
        const langName = getLanguageName(detectedLang);
        addMessage('system', `üåê Detected language: ${langName}`);
    }
    
    function getOrCreateSessionId() {
        let sessionId = sessionStorage.getItem('chatSessionId');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('chatSessionId', sessionId);
        }
        return sessionId;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Auto-focus message input
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('messageInput').focus();
    });
    
    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            document.getElementById('messageInput').focus();
        }
    });
</script>
{% endblock %}
